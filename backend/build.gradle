plugins {
    id 'java'
    alias(libs.plugins.spring.boot)
    alias(libs.plugins.spring.dependency.management)
    alias(libs.plugins.openapi.gradle.plugin)
    alias(libs.plugins.version.catalog.update)
}

group = 'com.boardly'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(libs.versions.java.get())
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation libs.bundles.spring.boot.dependencies
    implementation libs.bundles.common.dependencies
    testImplementation libs.bundles.spring.test.dependencies

    // h2
    runtimeOnly(libs.h2)

    // postgres
    runtimeOnly(libs.postgres)

    // springdoc
    implementation(libs.bundles.springdoc.dependencies)

    // flyway
    implementation(libs.bundles.flyway.dependencies)

    // lombok
    compileOnly(libs.lombok)
    annotationProcessor(libs.lombok)
    annotationProcessor(libs.lombok.mapstruct.binding)

    testCompileOnly(libs.lombok)
    testAnnotationProcessor(libs.lombok)
    testAnnotationProcessor(libs.lombok.mapstruct.binding)
}

tasks.named('test') {
    useJUnitPlatform()
}

// OpenAPI ë¬¸ì„œ ìƒì„± ì„¤ì •
openApi {
    apiDocsUrl.set("http://localhost:8080/api-docs")
    outputDir.set(project.layout.buildDirectory.dir("docs"))
    outputFileName.set("openapi.json")
    waitTimeInSeconds.set(30)
    customBootRun.args.add("--spring.profiles.active=dev")
}

// Static resources ë””ë ‰í„°ë¦¬ì— OpenAPI ë¬¸ì„œ ë³µì‚¬
tasks.register('copyOpenApiToStatic') {
    group = 'documentation'
    description = 'Copies OpenAPI documentation to static resources'
    dependsOn 'generateOpenApiDocs'

    doLast {
        def staticDir = file("src/main/resources/static/docs")
        staticDir.mkdirs()

        def sourceFile = file("build/docs/openapi.json")
        def targetFile = file("${staticDir}/openapi.json")

        if (sourceFile.exists()) {
            targetFile.text = sourceFile.text
            println "OpenAPI ë¬¸ì„œê°€ static resourcesì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ${targetFile}"
        }
    }
}

// í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ docs ë””ë ‰í„°ë¦¬ì— OpenAPI ë¬¸ì„œ ë³µì‚¬ (í”„ë¡ íŠ¸ì—”ë“œ íŒ€ ìš©)
tasks.register('copyOpenApiToProjectRoot') {
    group = 'documentation'
    description = 'Copies OpenAPI documentation to project root docs directory for frontend team'
    dependsOn 'generateOpenApiDocs'

    doLast {
        def projectDocsDir = file("../docs/api")
        projectDocsDir.mkdirs()

        def sourceFile = file("build/docs/openapi.json")
        def targetFile = file("${projectDocsDir}/openapi.json")
        def readmeFile = file("${projectDocsDir}/README.md")

        if (sourceFile.exists()) {
            // ê¸°ì¡´ íŒŒì¼ê³¼ ìƒˆ íŒŒì¼ì˜ ë‚´ìš©ì„ ë¹„êµ
            def contentChanged = false
            if (targetFile.exists()) {
                def existingContent = targetFile.text
                def newContent = sourceFile.text
                contentChanged = existingContent != newContent
            } else {
                contentChanged = true
            }

            // openapi.json íŒŒì¼ ë³µì‚¬
            targetFile.text = sourceFile.text

            // README íŒŒì¼ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
            def lastUpdateDate = contentChanged ? new Date().toString() : getLastUpdateDateFromReadme(readmeFile)

            readmeFile.text = """# Boardly API Documentation

## OpenAPI ì‚¬ì–‘ì„œ

- **JSON í˜•ì‹**: `openapi.json`
- **YAML í˜•ì‹**: `openapi.yml` (ê³§ ì œê³µ ì˜ˆì •)
- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **API Docs**: http://localhost:8080/api-docs

## í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ìƒì„±

ë‹¤ìŒ ë„êµ¬ë“¤ì„ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

### OpenAPI Generator
```bash
# TypeScript í´ë¼ì´ì–¸íŠ¸ ìƒì„±
npx @openapitools/openapi-generator-cli generate \\
  -i openapi.json \\
  -g typescript-axios \\
  -o ./generated-client

# JavaScript í´ë¼ì´ì–¸íŠ¸ ìƒì„±
npx @openapitools/openapi-generator-cli generate \\
  -i openapi.json \\
  -g javascript \\
  -o ./generated-client
```

### Swagger Codegen
```bash
# React Query í´ë¼ì´ì–¸íŠ¸ ìƒì„±
npx swagger-codegen-cli generate \\
  -i openapi.json \\
  -l typescript-fetch \\
  -o ./generated-client
```

## ì—…ë°ì´íŠ¸ ì£¼ê¸°

ì´ ë¬¸ì„œëŠ” ë°±ì—”ë“œ ë¹Œë“œ ì‹œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${lastUpdateDate}
"""

            def statusMessage = contentChanged ? "âœ… OpenAPI ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì–´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:" : "â„¹ï¸ OpenAPI ë¬¸ì„œê°€ ë³€ê²½ë˜ì§€ ì•Šì•„ ê¸°ì¡´ ë‚ ì§œë¥¼ ìœ ì§€í•©ë‹ˆë‹¤:"
            println statusMessage
            println "   ğŸ“„ JSON: ${targetFile}"
            println "   ğŸ“‹ README: ${readmeFile}"
            println "   ğŸŒ ì ‘ê·¼ URL: http://localhost:8080/docs/openapi.json"
        }
    }
}

// README íŒŒì¼ì—ì„œ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œë¥¼ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
def getLastUpdateDateFromReadme(readmeFile) {
    if (!readmeFile.exists()) {
        return new Date().toString()
    }

    def content = readmeFile.text
    def pattern = /ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: (.+)/
    def matcher = content =~ pattern

    if (matcher.find()) {
        return matcher.group(1)
    }

    return new Date().toString()
}

// YAML í˜•ì‹ OpenAPI ë¬¸ì„œë¥¼ ìœ„í•œ ì»¤ìŠ¤í…€ íƒœìŠ¤í¬
tasks.register('generateOpenApiYaml') {
    group = 'documentation'
    description = 'Generates OpenAPI documentation in YAML format'

    doLast {
        def docsDir = project.layout.buildDirectory.dir("docs").get().asFile
        docsDir.mkdirs()

        // ì„œë²„ ì‹œì‘
        def bootRun = project.tasks.named('bootRun')
        def process = new ProcessBuilder()
                .command('./gradlew', 'bootRun', '--args=--spring.profiles.active=dev')
                .directory(project.projectDir)
                .redirectErrorStream(true)
                .start()

        // ì„œë²„ ì‹œì‘ ëŒ€ê¸°
        Thread.sleep(15000)

        try {
            // YAML ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ
            def yamlContent = new URL("http://localhost:8080/api-docs.yaml").text
            new File(docsDir, "openapi.yml").text = yamlContent
            println "OpenAPI YAML ë¬¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${docsDir}/openapi.yml"
        } catch (Exception e) {
            println "OpenAPI YAML ë¬¸ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}"
        } finally {
            // ì„œë²„ ì¢…ë£Œ
            process.destroy()
        }
    }
}

// ë¹Œë“œ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ OpenAPI ë¬¸ì„œ ìƒì„±
tasks.named('build').configure {
    finalizedBy 'generateOpenApiDocs', 'copyOpenApiToStatic', 'copyOpenApiToProjectRoot'
}

// assemble íƒœìŠ¤í¬ì—ë„ ì˜ì¡´ì„± ì¶”ê°€ (jar ìƒì„± í›„)
tasks.named('assemble').configure {
    finalizedBy 'generateOpenApiDocs', 'copyOpenApiToStatic', 'copyOpenApiToProjectRoot'
}
